#!/bin/python3

import os, sys

MAIN_FNAME = "main.c"
SRC_PATH   = "lib/src"
OUT_FNAME  = "outp"

COMPILE_FLAGS = [
	"-static",
	"-masm=intel",
	"-nostdlib",
	"-fno-builtin",
	"-Wno-builtin-declaration-mismatch",
	"-O1",
	# "-z noexecstack",
]
COMPILE_FLAGS = " ".join(COMPILE_FLAGS)

CMD = f"cc {COMPILE_FLAGS} {MAIN_FNAME} {SRC_PATH}/*.c {SRC_PATH}/*.s"

def compile(name): return os.system(f"{CMD} -o {name}")
def do_the_thing(name):
	if compile(name) == 0:
		print(CMD)
		# run prog
		print("starting program:\n")
		print("----------------")
		x = os.system(f"./{name}")
		print()
		print("----------------")
		print("\nfinished running\nexited with code " + str(x))
		return x
	else: return -1


if len(sys.argv) > 1:
	match sys.argv[1]:
		case "diff":
			if not os.path.isfile(f"./{OUT_FNAME}"):
				print("pritn")
				exit(424)
			sec_fname = OUT_FNAME + "2"
			do_the_thing(sec_fname)
			b1 = open(OUT_FNAME, "rb").read(-1)
			b2 = open(sec_fname, "rb").read(-1)
			i = 0
			for byte in b1:
				if byte != b2[i]:
					print(f"diff found at offset 0x{hex(i).capitalize()[2:]}")
				i += 1
			os.remove(sec_fname)
			exit(0)
		case "debug":
			CMD += " -DDEBUG"
		case "asm":
			os.system(f"{CMD} -S")
			exit(0)
		case "clean":
			import glob
			for file in glob.glob("./*.s") + [f"./{OUT_FNAME}"]:
				os.remove(file) if os.path.isfile(file) else None
			exit(0)
		case _:
			print("huh")
			exit(-43)


rc = do_the_thing(OUT_FNAME)
exit(rc)